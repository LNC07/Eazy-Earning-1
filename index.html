<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Macrojob Website</title>
<style>
body {font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0;}
header {background:#222; color:#fff; padding:12px; text-align:center;}
.container {padding:20px;}
.box {background:#fff; padding:20px; margin:20px auto; border-radius:8px; max-width:500px; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
input, button, select {width:100%; padding:10px; margin:6px 0; border-radius:5px; border:1px solid #ccc;}
button {background:#222; color:#fff; cursor:pointer;}
button:hover {background:#444;}
.task {padding:10px; margin:8px 0; background:#e8e8e8; border-radius:5px;}
#dashboard {display:none;}
#loginBox, #signupBox, #resetBox {display:none;}
</style>
</head>
<body>
<header><h2>Macrojob Website</h2></header>

<div class="container">

<!-- Dashboard -->
<div id="dashboard" class="box">
  <h3>Welcome <span id="userName"></span> ðŸ‘‹</h3>
  <p>Coins: <span id="userCoins">0</span> <button onclick="showWithdraw()">Withdraw</button></p>
  <div id="withdrawBox" style="display:none; margin-top:10px;">
    <input type="text" id="withdrawAccount" placeholder="Bkash/Nagad Account Number">
    <input type="number" id="withdrawAmount" placeholder="Amount">
    <select id="withdrawMethod">
      <option value="Bkash">Bkash</option>
      <option value="Nagad">Nagad</option>
    </select>
    <button onclick="requestWithdraw()">Submit Withdraw</button>
  </div>

  <h4>Tasks</h4>
  <div id="taskList"></div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB3-ClSSDlKoVANTJOAYcnB3SZpEXjIBDE",
  authDomain: "fast-earn-5a485.firebaseapp.com",
  databaseURL: "https://fast-earn-5a485-default-rtdb.firebaseio.com",
  projectId: "fast-earn-5a485",
  storageBucket: "fast-earn-5a485.firebasestorage.app",
  messagingSenderId: "897353554923",
  appId: "1:897353554923:web:7010437d6353afa3ae17ae",
  measurementId: "G-VD8Q9CE9NX"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Auth observer
auth.onAuthStateChanged(async (user)=>{
  if(user){
    const userDoc = await db.collection("users").doc(user.uid).get();
    document.getElementById("userName").innerText = userDoc.data().name || "User";
    document.getElementById("userCoins").innerText = userDoc.data().coins || 0;
    loadTasks();
    document.getElementById("dashboard").style.display = "block";
  }
});

// Load tasks
async function loadTasks(){
  const user = auth.currentUser;
  if(!user) return;
  const userRef = db.collection("users").doc(user.uid);
  const userDoc = await userRef.get();
  const taskHistory = userDoc.data().taskHistory || {};

  const taskListDiv = document.getElementById("taskList");
  taskListDiv.innerHTML = "";

  const snapshot = await db.collection("tasks").orderBy("createdAt","desc").get();
  snapshot.forEach(doc=>{
    const t = doc.data();
    t.id = doc.id;
    const div = document.createElement("div");
    div.className = "task";
    div.innerHTML = `<strong>${t.title}</strong> - ${t.reward} coins<br>Link: <a href="${t.link}" target="_blank">${t.link}</a><br>
      <button id="taskBtn-${t.id}">Start Task</button>
      <span id="count-${t.id}"></span>`;
    taskListDiv.appendChild(div);

    div.querySelector("button").onclick = async ()=>{
      const btn = div.querySelector("button");
      btn.disabled = true;

      // Open task link
      const win = window.open(t.link, "_blank");

      // 20s countdown with visible 1,2,3...
      const counterSpan = document.getElementById(`count-${t.id}`);
      let sec = 1;
      const interval = setInterval(()=>{
        counterSpan.innerText = sec;
        sec++;
        if(sec>20){ clearInterval(interval); counterSpan.innerText="Done!"; win.close(); completeTask(t.id, t.reward); }
      },1000);
    };
  });
}

// Complete task
async function completeTask(taskId, reward){
  const user = auth.currentUser;
  if(!user) return;
  const userRef = db.collection("users").doc(user.uid);
  const userDoc = await userRef.get();
  let coins = (userDoc.data().coins || 0) + reward;
  let history = userDoc.data().taskHistory || {};
  history[taskId] = Date.now();
  await userRef.update({coins: coins, taskHistory: history});
  document.getElementById("userCoins").innerText = coins;
  alert("Task Completed! Coins added.");
}

// Withdraw
function showWithdraw(){ document.getElementById("withdrawBox").style.display="block"; }
async function requestWithdraw(){
  const user = auth.currentUser;
  const amount = parseInt(document.getElementById("withdrawAmount").value);
  const account = document.getElementById("withdrawAccount").value.trim();
  const method = document.getElementById("withdrawMethod").value;
  if(!user || !amount || !account){ alert("Enter valid details"); return; }

  const userRef = db.collection("users").doc(user.uid);
  const userDoc = await userRef.get();
  const coins = userDoc.data().coins || 0;
  if(coins < amount){ alert("Insufficient balance!"); return; }

  await userRef.update({coins: coins - amount});
  await db.collection("withdraws").add({userId:user.uid, amount, account, method, status:"pending", createdAt:Date.now()});
  alert("Withdraw requested! Coins deducted.");
  document.getElementById("userCoins").innerText = coins - amount;
}

</script>
</body>
</html>
